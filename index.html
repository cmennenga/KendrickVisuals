<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<body>
    <canvas id="myCanvas"></canvas>

    <script>
    /* global nn */
    nn.get('body').css({ backgroundColor: "black" })

    const canvas  = document.getElementById("myCanvas")
    const ctx = canvas.getContext("2d")

    // resizing screen
    function resizeScreen() {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
    }
    window.addEventListener('resize', resizeScreen)
    resizeScreen()

    // creating class for each dot
    class Dot {
        constructor(x, y, speed) {
            this.x = x
            this.y = y
            this.endX = x
            this.endY = y
            this.speed = speed
        }

        // sets target location to create image
        Target(x, y) {
            this.endX = x
            this.endY = y
        }

        // sets a random location if not creating an image
        randLocation() {
            this.Target(Math.random() * canvas.width, 
                        Math.random() * canvas.height)
        }

        // function called every frame to move dot
        update() {
            let dx = this.endX - this.x
            let dy = this.endY - this.y
            let dist = Math.sqrt(dx*dx + dy*dy)

            if (dist > this.speed) {
                this.x += this.speed * (dx/dist)
                this.y += this.speed * (dy/dist)
            } else {
                this.x = this.endX
                this.y = this.endY
            }
        }

        // actually creating the dot
        create() {
            ctx.beginPath()
            ctx.arc(this.x, this.y, 2, 0, 2* Math.PI)
            ctx.fillStyle = 'white'
            ctx.fill()
            ctx.closePath()
        }
    }

    // creating all my dots
    let nDots = 100000 
    let dots = []

    for (let d = 0; d < nDots; d+=1) {
        let startX = Math.random() * canvas.width
        let startY = Math.random() * canvas.height
        dots.push(new Dot(startX, startY, 10))
    }

    let currImg = ''

    //setting up music 
    let music = nn.create('audio').addTo('body')
    let justFine = music.el

    music.src = 'justFine.mp3'
    music.loop = true

    // creating image dot function
    function drawImgAndExtractDots(img) {
        let offcanvas = document.createElement('canvas')
        let offctx = offcanvas.getContext("2d")
        offcanvas.width = canvas.width
        offcanvas.height = canvas.height

        // Scaling image to fit screen
        let imgAspect = img.width / img.height
        let canvasAspect = canvas.width / canvas.height
        let dx, dy, dWidth, dHeight

        if (imgAspect > canvasAspect) {
            dWidth = canvas.width
            dHeight = canvas.width/imgAspect
            dx = 0
            dy = (canvas.height - dHeight) / 2
        } else {
            dWidth = canvas.height * imgAspect
            dHeight = canvas.height
            dx = (canvas.width - dWidth) / 2
            dy = 0
        }
        offctx.drawImage(img, dx, dy, dWidth, dHeight)

        // extract image pixel data
        let imgData = offctx.getImageData(0, 0, canvas.width, canvas.height).data
        let imgTarget = []

        // create dot target points
        for (let w =0; w<canvas.height; w+=3) {
            for (let z=0; z<canvas.width; z+=3) {
                let index = (w * canvas.width + z) * 4
                // calculating brightness to find where dots go
                let r = imgData[index]
                let g = imgData[index + 1]
                let b = imgData[index + 2]
                let brightness = (r+g+b) / 3

                if (brightness > 100) {
                    imgTarget.push({x: z, y: w})
                }
            }
        }

        // connecting dots to imgTarget
        for (let i = 0; i < nDots; i+=1) {
            if (i < imgTarget.length) {
                dots[i].Target(imgTarget[i].x, imgTarget[i].y)
            } else {
                let rand = imgTarget[Math.floor(Math.random() * imgTarget.length)]
                dots[i].Target(rand.x, rand.y)
            }
        }
    }

    // loading images and moving dots based off music
    function LoadImages(image) {
        let img = new Image()
        img.src = image
        img.onload = () => {
            drawImgAndExtractDots(img)
        }
    }

    // building visual story
    let story = [
        {time: 0,   mode: 'random'},
        {time: 0.05, mode: 'random'},
        {time: 5,   mode: 'image',  src: 'testimage.jpg'},
        {time: 10,  mode: 'image',  src: 'img2.jpg'},
        {time: 14,  mode: 'image',  src: 'img6.jpg'},
        {time: 17,  mode: 'image',  src: 'img9.jpg'},
        {time: 20,  mode: 'fast'},
        {time: 21,  mode: 'slow'}, 
        {time: 22,  mode: 'image',  src: 'img3.jpg'},
        {time: 26,  mode: 'image',  src: 'img14.jpg'},
        {time: 30,  mode: 'image',  src: 'img10.jpg'},
        {time: 34,  mode: 'slow'},
        {time: 36,  mode: 'image',  src: 'img15.jpg'},
        {time: 40,  mode: 'image',  src: 'img4.jpg'},
        {time: 44,  mode: 'fast'},
        {time: 44.5,  mode: 'image',  src: 'img7.jpg'},
        {time: 49,  mode: 'image',  src: 'img12.jpg'},
        {time: 53,  mode: 'slow'}
    ]

    let currentVisual = 0
    // moving the dots 
    function move() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)

        let t = music.currentTime

        if (
            currentVisual < story.length -1 && 
            t>= story[currentVisual +1].time
        ) {
            currentVisual += 1 
            let visual = story[currentVisual]

            if (visual.mode === 'random') {
                for (let d of dots) d.randLocation()
            } else if (visual.mode === 'image') { 
                for (let d of dots) d.speed = 30
                LoadImages(visual.src)
            } else if (visual.mode === 'fast') {
                for (let d of dots) {
                    d.speed = 70
                    d.randLocation()
                }
            } else {
                for (let d of dots) {
                    d.speed = 0.2
                    d.randLocation()
                }
            }
        }

        for (let d of dots) {
            d.update()
            d.create()
        }
        requestAnimationFrame(move)
    }
    
    document.body.addEventListener('click', () => {
        music.play();
        move()
        }
    )
    </script>
</body>