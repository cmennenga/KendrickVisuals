<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<body>
    <canvas id="myCanvas"></canvas>

    <script>
    /* global nn */
    nn.get('body').css({ backgroundColor: "black" })

    const canvas  = document.getElementById("myCanvas")
    const ctx = canvas.getContext("2d")

    // resizing screen
    function resizeScreen() {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
    }
    window.addEventListener('resize', resizeScreen)
    resizeScreen()

    // creating class for each dot
    class Dot {
        constructor(startX, startY, endX, endY, speed) {
            this.x = startX
            this.y = startY
            this.endX = endX
            this.endY = endY
            this.speed = speed
        }

        // function called every frame to move dot
        update() {
            let dx = this.endX - this.x
            let dy = this.endY - this.y
            let dist = Math.sqrt(dx*dx + dy*dy)

            if (dist > this.speed) {
                this.x += this.speed * (dx/dist)
                this.y += this.speed * (dy/dist)
            } else {
                this.x = this.endX
                this.y = this.endY
            }
        }

        // actually creating the dot
        create() {
            ctx.beginPath()
            ctx.arc(this.x, this.y, 2, 0, 2* Math.PI)
            ctx.fillStyle = 'white'
            ctx.fill()
            ctx.closePath()
        }
    }

    // creating all my dots
    let dots = []

    // for (let i = 0; i<5000; i++) {
        // let startX = Math.random() * canvas.width
        // let startY = Math.random() * canvas.height

        // let endX = Math.random() * canvas.width
        // let endY = Math.random() * canvas.height 

        // let speed = 1 + Math.random() * 2

        // dots.push(new Dot(startX, startY, endX, endY, speed))
    // }

     // creating image out of dots 
    let testImage = new Image()
    testImage.src = "testimage.jpg"
    testImage.onload = () => {drawImgAndExtractDots(testImage); move()}

    // creating image dot function
    function drawImgAndExtractDots(img) {
        let offcanvas = document.createElement('canvas')
        let offctx = offcanvas.getContext("2d")
        offcanvas.width = canvas.width
        offcanvas.height = canvas.height

        // Scaling image to fit screen
        let imgAspect = img.width / img.height
        let canvasAspect = canvas.width / canvas.height
        let dx, dy, dWidth, dHeight

        if (imgAspect > canvasAspect) {
            dWidth = canvas.width
            dHeight = canvas.width/imgAspect
            dx = 0
            dy = (canvas.height - dHeight) / 2
        } else {
            dWidth = canvas.height * imgAspect
            dHeight = canvas.height
            dx = (canvas.width - dWidth) / 2
            dy = 0
        }
        offctx.drawImage(img, dx, dy, dWidth, dHeight)

        // extract image pixel data
        let imgData = offctx.getImageData(0, 0, canvas.width, canvas.height).data

        // create dot target points
        for (let y =0; y<canvas.height; y+=3) {
            for (let x=0; x<canvas.width; x+=3) {
                let index = (y * canvas.width + x) * 4
                // calculating brightness to find where dots go
                let r = imgData[index]
                let g = imgData[index + 1]
                let b = imgData[index + 2]
                let brightness = (r+g+b) / 3

                if (brightness > 128) {
                    let startX = Math.random() * canvas.width
                    let startY = Math.random() * canvas.height

                    let speed = 30

                    dots.push(new Dot(startX, startY, x, y, speed))
                }
            }
        }
    }

    // moving the dots 
    function move() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)

        for (let d of dots) {
            d.update()
            d.create()
        }
        requestAnimationFrame(move)
    }
    </script>
</body>